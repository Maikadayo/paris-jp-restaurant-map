<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Paris Japanese Night — Cluster & Filters</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
<style>
  :root { --panel-w: 320px; }
  html, body { height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", Arial, sans-serif; }
  #map { position:absolute; top:0; bottom:0; left:0; right:0; }
  #panel {
    position:absolute; top:10px; left:10px; width:var(--panel-w);
    background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.15);
    padding:14px 14px 10px; z-index:10;
  }
  #panel h2 { margin:6px 0 8px; font-size:16px; }
  #panel .row { margin:8px 0; }
  .range { width:100%; }
  .small { color:#555; font-size:12px; }
  .badge { display:inline-block; background:#f2f4f8; border-radius:999px; padding:3px 8px; font-size:12px; margin-left:6px; }
  .legend { display:flex; gap:8px; align-items:center; margin-top:6px; }
  .dot { width:10px; height:10px; border-radius:50%; background:#ee7623; border:2px solid white; box-shadow:0 0 2px rgba(0,0,0,.5); }
  .btn { display:inline-block; border:1px solid #ddd; border-radius:8px; padding:6px 10px; background:#fff; cursor:pointer; }
  .btn:active { transform: translateY(1px); }
  .footer { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
  @media (max-width: 720px){
    :root { --panel-w: calc(100vw - 20px); }
  }
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h2>夜の日本食マップ <span id="count" class="badge">0件</span></h2>

  <div class="row">
    <div class="small">価格帯（Google price_level）</div>
    <label><input type="checkbox" class="pl" value="0" checked> € (0)</label>
    <label><input type="checkbox" class="pl" value="1" checked> € (1)</label>
    <label><input type="checkbox" class="pl" value="2" checked> €€ (2)</label>
    <label><input type="checkbox" class="pl" value="none" checked> 不明</label>
  </div>

  <div class="row">
    <div>最低スコア: <span id="scoreVal" class="badge">0.00</span></div>
    <input id="score" class="range" type="range" min="0" max="1" step="0.01" value="0">
  </div>

  <div class="row">
    <div>最低評価(⭐): <span id="ratingVal" class="badge">0.0</span></div>
    <input id="rating" class="range" type="range" min="0" max="5" step="0.1" value="0">
  </div>

  <div class="row">
    <button id="reset" class="btn">フィルタをリセット</button>
    <button id="download" class="btn">表示中データをダウンロード</button>
  </div>

  <div class="legend small">
    <div class="dot"></div> ピンをクリックで詳細（店名/スコア/評価/住所/Googleマップ）
  </div>

  <div class="footer small">
    Map: © Mapbox © OpenStreetMap
  </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
<script>
  // ==== 設定 ====
  const MAPBOX_TOKEN = "pk.eyJ1IjoiaGFydWNoYW5uIiwiYSI6ImNsdnFkaThuajAxdnYya253dDZqZjdrYWEifQ.-K4v14BLsZ0f7P6SrzRnfA; // ← あなたのMapbox公開トークン
  const GEOJSON_URL = "./paris_japanese_night.geojson"; // 同じフォルダに置く

  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [2.3522, 48.8566],
    zoom: 12
  });

  let originalData = null;
  let currentData = null;

  const $score = document.getElementById('score');
  const $scoreVal = document.getElementById('scoreVal');
  const $rating = document.getElementById('rating');
  const $ratingVal = document.getElementById('ratingVal');
  const $count = document.getElementById('count');
  const $reset = document.getElementById('reset');
  const $download = document.getElementById('download');
  const $plChecks = Array.from(document.querySelectorAll('.pl'));

  function updateBadges() {
    $scoreVal.textContent = Number($score.value).toFixed(2);
    $ratingVal.textContent = Number($rating.value).toFixed(1);
  }

  function countVisible() {
    const n = currentData?.features?.length ?? 0;
    $count.textContent = `${n}件`;
  }

  function filterFeatures(features) {
    const minScore = parseFloat($score.value);
    const minRating = parseFloat($rating.value);
    const allowedPL = new Set(
      $plChecks.filter(c => c.checked).map(c => c.value)
    );
    return features.filter(f => {
      const p = f.properties || {};
      const score = Number(p.score ?? 0);
      const rating = Number(p.rating ?? 0);
      const pl = (p.price_level === null || p.price_level === undefined) ? 'none' : String(p.price_level);
      if (!allowedPL.has(pl)) return false;
      if (score < minScore) return false;
      if (rating < minRating) return false;
      return true;
    });
  }

  function applyFilters() {
    if (!originalData) return;
    const filtered = filterFeatures(originalData.features);
    currentData = { type: 'FeatureCollection', features: filtered };
    // Sourceに再投入して再クラスタリング
    const src = map.getSource('places');
    if (src) {
      src.setData(currentData);
    }
    countVisible();
  }

  function downloadVisible() {
    if (!currentData) return;
    const blob = new Blob([JSON.stringify(currentData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {
      href: url, download: 'filtered_paris_japanese_night.geojson'
    });
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  async function init() {
    const res = await fetch(GEOJSON_URL);
    originalData = await res.json();
    currentData = originalData;

    map.on('load', () => {
      // クラスタリング有効なSource
      map.addSource('places', {
        type: 'geojson',
        data: currentData,
        cluster: true,
        clusterMaxZoom: 15,   // ズームでクラスター解除
        clusterRadius: 50     // クラスターの半径(px)
      });

      // クラスター円の塗り（件数で色分け）
      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: 'places',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': [
            'step',
            ['get', 'point_count'],
            '#A0D7A7', 20,
            '#66B3FF', 50,
            '#FFB84D'
          ],
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            14, 20,
            18, 50,
            24
          ]
        }
      });

      // クラスターの数字ラベル
      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: 'places',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
          'text-size': 12
        }
      });

      // 単独ポイント
      map.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: 'places',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': '#ee7623',
          'circle-stroke-color': '#ffffff',
          'circle-stroke-width': 2,
          'circle-radius': 6
        }
      });

      // クリック：クラスター→ズーム拡張
      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('places').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          map.easeTo({ center: features[0].geometry.coordinates, zoom: zoom });
        });
      });

      // クリック：単独ポイント→ポップアップ
      map.on('click', 'unclustered-point', (e) => {
        const f = e.features[0];
        const p = f.properties;
        const coords = f.geometry.coordinates.slice();
        const price = (p.price_level === null || p.price_level === undefined) ? "€?" : `€${p.price_level}`;
        const rating = (p.rating ?? '-');
        const reviews = (p.reviews ?? '-');
        const score = Number(p.score ?? 0).toFixed(3);
        const name = p.name ?? '(名称不明)';
        const address = p.address ?? '';
        const link = p.gmaps_url ?? '#';
        const html = `
          <b>${name}</b><br/>
          スコア: ${score}<br/>
          評価: ${rating}（${reviews}件）<br/>
          価格帯: ${price}<br/>
          住所: ${address}<br/>
          <a href="${link}" target="_blank" rel="noopener">Googleマップで開く</a>
        `;
        new mapboxgl.Popup({offset:8}).setLngLat(coords).setHTML(html).addTo(map);
      });

      // カーソル
      map.on('mouseenter', 'clusters', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', 'clusters', () => map.getCanvas().style.cursor = '');
      map.on('mouseenter', 'unclustered-point', () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', 'unclustered-point', () => map.getCanvas().style.cursor = '');

      // UIイベント
      [$score, $rating, ...$plChecks].forEach(el => el.addEventListener('input', () => {
        updateBadges(); applyFilters();
      }));
      $reset.addEventListener('click', () => {
        $score.value = 0; $rating.value = 0;
        $plChecks.forEach(c => c.checked = true);
        updateBadges(); applyFilters();
      });
      $download.addEventListener('click', downloadVisible);

      updateBadges();
      countVisible();
    });
  }

  init();
</script>
</body>
</html>
