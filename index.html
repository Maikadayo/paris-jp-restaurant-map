<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Paris Japanese Night — Satellite • Clusters • Filters</title>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root { --panel-w: 360px; --bg:#0a0f14; --fg:#d7e1ea; --muted:#7991a1; --accent:#18e0ff; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--fg);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, sans-serif; }
  #map { position:absolute; inset:0; }
  /* subtle tech grid overlay */
  #map::after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background-image: radial-gradient(rgba(24,224,255,.06) 1px, transparent 1px);
    background-size: 18px 18px;
  }
  #panel {
    position:absolute; top:12px; left:12px; width:var(--panel-w);
    background: rgba(8,12,18,.76); backdrop-filter: blur(8px);
    border: 1px solid rgba(24,224,255,.25);
    box-shadow: 0 10px 30px rgba(0,0,0,.45), 0 0 40px rgba(24,224,255,.07) inset;
    border-radius:14px; padding:14px; z-index:10;
  }
  #panel h2 { margin:6px 0 10px; font-size:16px; letter-spacing:.3px; }
  code { font-family:"JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, monospace; }
  .row { margin:12px 0; }
  .small { color:var(--muted); font-size:12px; }
  .badge { display:inline-block; background:rgba(24,224,255,.14); color:var(--accent);
           border:1px solid rgba(24,224,255,.35); border-radius:999px; padding:3px 8px; font-size:12px;
           font-family:"JetBrains Mono", ui-monospace; margin-left:8px; }
  .grp { display:flex; flex-wrap:wrap; gap:8px 12px; margin-top:8px; }
  .grp label { font-size:13px; user-select:none; }
  input[type="checkbox"]{ accent-color: var(--accent); }
  .btn, select {
    background: rgba(16,22,30,.85); color:var(--fg);
    border:1px solid rgba(122,140,160,.45); border-radius:10px;
    padding:8px 10px; cursor:pointer;
  }
  .btn:hover, select:hover { border-color: rgba(24,224,255,.6); }
  .btn:active { transform: translateY(1px); }
  .legend { display:flex; gap:8px; align-items:center; margin-top:6px; }
  .dot { width:10px; height:10px; border-radius:50%; background:#18e0ff; box-shadow:0 0 6px #18e0ff; border:2px solid #fff; }
  a { color: var(--accent); }
  @media (max-width: 720px){ :root { --panel-w: calc(100vw - 24px); } }
  /* Popup: dark background + white text; keep links cyan */
  .mapboxgl-popup-content {
    background:#111 !important; color:#fff !important; border-radius:8px;
    box-shadow: 0 8px 24px rgba(0,0,0,.6);
  }
  .mapboxgl-popup-content a { color:#18e0ff !important; }
  .mapboxgl-popup-tip { border-top-color:#111 !important; border-bottom-color:#111 !important; }
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h2>Japanese Restaurants at Night <span id="count" class="badge">0 items</span></h2>

  <div class="row">
    <div class="small">Price level (<code>price_level</code>)</div>
    <div class="grp">
      <label><input type="checkbox" class="pl" value="0" checked> € (0)</label>
      <label><input type="checkbox" class="pl" value="1" checked> € (1)</label>
      <label><input type="checkbox" class="pl" value="2" checked> €€ (2)</label>
      <label><input type="checkbox" class="pl" value="none" checked> Unknown</label>
    </div>
  </div>

  <div class="row">
    <div class="small">Score range (0.15–0.49, multiple)</div>
    <div class="grp" id="scoreRanges">
      <label><input type="checkbox" value="0.40-0.49" checked> 0.40–0.49</label>
      <label><input type="checkbox" value="0.30-0.40" checked> 0.30–0.40</label>
      <label><input type="checkbox" value="0.20-0.30" checked> 0.20–0.30</label>
      <label><input type="checkbox" value="0.15-0.20" checked> 0.15–0.20</label>
    </div>
  </div>

  <div class="row">
    <div class="small">Rating range (0–5 ★, multiple)</div>
    <div class="grp" id="ratingRanges">
      <label><input type="checkbox" value="4-5" checked> 4–5★</label>
      <label><input type="checkbox" value="3-4" checked> 3–4★</label>
      <label><input type="checkbox" value="2-3" checked> 2–3★</label>
      <label><input type="checkbox" value="0-2" checked> 0–2★</label>
    </div>
  </div>

  <div class="row">
    <div class="small">Sort by</div>
    <select id="sortBy">
      <option value="score-desc" selected>Score ↓</option>
      <option value="rating-desc">Rating ↓</option>
      <option value="reviews-desc">Reviews ↓</option>
      <option value="price-asc">Price (cheaper first)</option>
      <option value="name-asc">Name A→Z</option>
    </select>
  </div>

  <div class="row">
    <button id="reset" class="btn">Reset filters</button>
    <button id="download" class="btn">Download visible</button>
  </div>

  <div class="legend small">
    <div class="dot"></div> Click a pin for details (name / score / rating / address / Google Maps)
  </div>
  <div class="small" style="margin-top:6px;">Map: © Mapbox © OpenStreetMap</div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
<script>
  // ==== Configuration ====
  const MAPBOX_TOKEN = "pk.eyJ1IjoiaGFydWNoYW5uIiwiYSI6ImNsdnFlZWRidTAyNmkya21yem1wMjhzZHUifQ.GrEXJlVvv0ljdkQXoEQTTQ";     // ← your public Mapbox token
  const GEOJSON_URL  = "./paris_japanese_night.geojson"; // or absolute URL

  // Satellite (dark-ish) base
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/satellite-streets-v12',
    center: [2.3522, 48.8566],
    zoom: 12
  });

  let originalData = null;
  let currentData  = null;

  const $count = document.getElementById('count');
  const $reset = document.getElementById('reset');
  const $download = document.getElementById('download');
  const $plChecks = Array.from(document.querySelectorAll('.pl'));
  const $scoreRanges = Array.from(document.querySelectorAll('#scoreRanges input[type=checkbox]'));
  const $ratingRanges = Array.from(document.querySelectorAll('#ratingRanges input[type=checkbox]'));
  const $sortBy = document.getElementById('sortBy');

  // ---- helpers ----
  const parseRange = (s)=> s.split('-').map(Number);
  const selectedRanges = (nodes)=> nodes.filter(n=>n.checked).map(n=>parseRange(n.value));
  function inAnyRange(val, ranges, inclusiveUpper=false){
    if (ranges.length===0) return true;
    return ranges.some(([lo,hi]) => inclusiveUpper ? (val>=lo && val<=hi+1e-12) : (val>=lo && val<hi));
  }
  const allowedPL = ()=> new Set($plChecks.filter(c=>c.checked).map(c=>c.value));

  function sortFeatures(features){
    const v = $sortBy.value;
    const cmp = {
      "score-desc":  (a,b)=> (+(b.properties.score ?? 0)) - (+(a.properties.score ?? 0)),
      "rating-desc": (a,b)=> (+(b.properties.rating ?? 0)) - (+(a.properties.rating ?? 0)),
      "reviews-desc":(a,b)=> (+(b.properties.reviews ?? 0)) - (+(a.properties.reviews ?? 0)),
      "price-asc":   (a,b)=> (a.properties.price_level ?? 99) - (b.properties.price_level ?? 99),
      "name-asc":    (a,b)=> String(a.properties.name ?? "").localeCompare(String(b.properties.name ?? ""))
    }[v] || (()=>0);
    return features.slice().sort(cmp);
  }

  function filterFeatures(features){
    const scoreSel = selectedRanges($scoreRanges);
    const ratingSel = selectedRanges($ratingRanges);
    const allowed = allowedPL();
    return features.filter(f=>{
      const p = f.properties || {};
      const score = Number(p.score ?? 0);
      const rating = Number(p.rating ?? 0);
      const pl = (p.price_level===null || p.price_level===undefined) ? 'none' : String(p.price_level);
      if (!allowed.has(pl)) return false;
      if (!inAnyRange(score,  scoreSel,  true)) return false; // inclusiveUpper
      if (!inAnyRange(rating, ratingSel, true)) return false;
      return true;
    });
  }

  function applyFilters(){
    if (!originalData) return;
    const filtered = filterFeatures(originalData.features);
    const sorted   = sortFeatures(filtered);
    currentData    = { type:'FeatureCollection', features: sorted };
    const src = map.getSource('places');
    if (src) src.setData(currentData);
    $count.textContent = `${sorted.length} items`;
  }

  function downloadVisible(){
    if (!currentData) return;
    const blob = new Blob([JSON.stringify(currentData, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href:url, download:'filtered_paris_japanese_night.geojson' });
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  async function init(){
    const res = await fetch(GEOJSON_URL);
    originalData = await res.json();
    currentData  = originalData;

    map.on('load', () => {
      map.addSource('places', {
        type:'geojson', data: currentData, cluster:true, clusterMaxZoom:15, clusterRadius:50
      });

      // Clusters (neon-ish)
      map.addLayer({
        id:'clusters', type:'circle', source:'places', filter:['has','point_count'],
        paint:{
          'circle-color': ['step',['get','point_count'],
            '#16c7e0', 20, '#4c77ff', 50, '#a05bff'
          ],
          'circle-radius': ['step',['get','point_count'], 14, 20, 18, 50, 24],
          'circle-stroke-color':'#091219', 'circle-stroke-width':1
        }
      });

      map.addLayer({
        id:'cluster-count', type:'symbol', source:'places', filter:['has','point_count'],
        layout:{ 'text-field':['get','point_count_abbreviated'], 'text-font':['DIN Offc Pro Medium','Arial Unicode MS Bold'], 'text-size':12 },
        paint:{ 'text-color':'#eaf7ff' }
      });

      // Single points
      map.addLayer({
        id:'unclustered-point', type:'circle', source:'places', filter:['!',['has','point_count']],
        paint:{
          'circle-color':'#18e0ff', 'circle-radius':6,
          'circle-stroke-color':'#ffffff', 'circle-stroke-width':1.8
        }
      });

      // Interactions
      map.on('click','clusters', e=>{
        const features = map.queryRenderedFeatures(e.point,{layers:['clusters']});
        const clusterId = features[0].properties.cluster_id;
        map.getSource('places').getClusterExpansionZoom(clusterId,(err,zoom)=>{
          if (err) return; map.easeTo({center:features[0].geometry.coordinates, zoom});
        });
      });

      map.on('click','unclustered-point', e=>{
        const f = e.features[0], p=f.properties, coords=f.geometry.coordinates.slice();
        const priceTxt  = (p.price_level===null || p.price_level===undefined) ? "€?" : `€${p.price_level}`;
        const scoreTxt  = Number(p.score ?? 0).toFixed(3);
        const ratingTxt = (p.rating ?? '-');
        const reviewsTxt= (p.reviews ?? '-');
        const name = p.name ?? '(unknown)'; const addr = p.address ?? ''; const link = p.gmaps_url ?? '#';
        new mapboxgl.Popup({offset:8})
          .setLngLat(coords)
          .setHTML(`
            <div style="min-width:240px; font-size:13px;">
              <b>${name}</b><br/>
              <span style="font-family:'JetBrains Mono',monospace;">score=${scoreTxt} • rating=${ratingTxt} • reviews=${reviewsTxt}</span><br/>
              price=${priceTxt}<br/>
              ${addr}<br/>
              <a href="${link}" target="_blank" rel="noopener">Open in Google Maps</a>
            </div>
          `).addTo(map);
      });

      map.on('mouseenter','clusters',()=> map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','clusters',()=> map.getCanvas().style.cursor='');
      map.on('mouseenter','unclustered-point',()=> map.getCanvas().style.cursor='pointer');
      map.on('mouseleave','unclustered-point',()=> map.getCanvas().style.cursor='');

      // UI events
      [...$plChecks, ...$scoreRanges, ...$ratingRanges].forEach(el => el.addEventListener('input', applyFilters));
      $sortBy.addEventListener('change', applyFilters);
      $reset.addEventListener('click', ()=>{
        $plChecks.forEach(c=>c.checked=true);
        $scoreRanges.forEach(c=>c.checked=true);
        $ratingRanges.forEach(c=>c.checked=true);
        $sortBy.value='score-desc';
        applyFilters();
      });
      $download.addEventListener('click', downloadVisible);

      applyFilters();
    });
  }
  init();

  // debug hook if needed
  map.on('error', e => console.error('Mapbox error:', e && e.error));
</script>
</body>
</html>
